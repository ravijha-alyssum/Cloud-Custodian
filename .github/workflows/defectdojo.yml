name: Cloud Custodian 

on:
  workflow_dispatch:
    inputs:
      cloud_provider:
        description: 'Cloud Provider to Scan'
        required: true
        default: 'aws'
        type: choice
        options:
          - aws
          - azure
          - gcp
      aws_region:
        description: 'AWS Region to Scan (if provider is aws)'
        required: false
        default: 'ap-south-1'

jobs:
  run-cloud-custodian:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        if: ${{ github.event.inputs.cloud_provider == 'aws' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ github.event.inputs.aws_region }}

      - name: Login to Azure
        if: ${{ github.event.inputs.cloud_provider == 'azure' }}
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Authenticate to Google Cloud
        if: ${{ github.event.inputs.cloud_provider == 'gcp' }}
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

      - name: Setup Cloud Custodian
        uses: gscho/setup-cloud-custodian@v1
        with:
          include-azure: ${{ github.event.inputs.cloud_provider == 'azure' }}
          include-gcp: ${{ github.event.inputs.cloud_provider == 'gcp' }}

      - name: Run Cloud Custodian Scan
        id: custodian-scan
        run: |
          PROVIDER=${{ github.event.inputs.cloud_provider }}
          custodian run --output-dir="output-$PROVIDER" "Policies/$PROVIDER/"

      - name: Upload Scan Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: custodian-report-${{ github.event.inputs.cloud_provider }}
          path: output-${{ github.event.inputs.cloud_provider }}/
